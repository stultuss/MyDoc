MySQL
=========================

> 记录日常工作中的一些问题

## 介绍

MySQL 是一种关系型数据库，它是开源的，可以很方便的进行扩展。

## 数据库引擎

MySQL 有两种数据库引擎可供选择：

- MyISAM 引擎
- InnoDB 引擎

两者各有自己的特点，我们需要记住两者的区别：

1. MyISAM 只有表锁，而 InnoDB 则同时支持行锁和表锁。
2. MyISAM 不提供事务，而 InnoDB 支持事务。
3. MyISAM 不支持外键，而 InnoDB 支持外键
4. InnoDB 支持 MVCC，应对高并发事务，MVCC 比单纯的加锁更高效。
5. InnoDB 会发生全表扫描：`select count(*) from table`

**总结：MyISAM 更强调的是性能，而 InnoDB 更注重安全**。

##  锁

数据库处理并发和同步主要通过锁来实现，一种是代码层面的锁，一种是数据库层面的锁，比较典型的锁是悲观锁和乐观锁，这两种锁都是数据库层面的锁。

### 悲观锁

悲观锁总是假设最坏的情况，每次去拿数据的时候都认为别人会修改。所以每次拿数据都会上锁，这样别人想拿数据就会阻塞直到它拿到锁。**悲观锁适用于多写的场景**

```mysql
select ...for update
```

### 乐观锁

乐观锁总是假设最好的情况，每次去拿数据的时候都认为别人不会修改，所以不会上锁。但在更新时候会判断一下此期间别人是否更新了这个数据，或者使用版本号和CAS算法实现。**乐观锁适用于多读场景，可以提高吞吐量**。

#### 版本号机制

一般在数据表上加一个数据版本号 version 字段。表示数据被修改的次数。当数据被修改 version + 1，提交更新时，只有当 version 值相等才更新。否则提交失败，避免了记录被覆盖的情况。

**总结：写用悲观锁，读用乐观锁**

## 数据库优化

关于数据库优化方面，涉入并不深，勉强到达能用的地步。简单阐述一下几个主要的手段。

### 1. 读写分离

这是最经典的数据库拆分方案，主库负责写，从库负责读。

### 2. 限制范围

- 禁止全表扫描 (InnoDB)

- 禁止不带限制数据范围条件的查询，举例：只允许查询一个月内的订单数据

### 3. 垂直分区

将数据表列拆分，减少列数，简化表结构，易于维护。缺点是增加冗余，增加 Join 操作，事务变的更复杂。

举例：表A保存有玩家的游戏数据和平台数据，垂直分区后表A只保存游戏数据，表B保存平台数据。

### 4. 水平分区

保持数据表结构不表，通过代码控制（策略）将存储数据分片，每一片数据分散到不同的表或者库中，达到分布式的目的。水平拆分可以支撑非茶大的数据量。缺点是整体数据的统计会比较麻烦。